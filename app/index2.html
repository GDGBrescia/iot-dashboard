<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="utf-8">
        <meta name="Description" content="">
        <title>IoT Dashboard - Powered by GDG Brescia & T4SM</title>
        <link rel="stylesheet" href="css/bootstrap.min.css" >
        <link rel="stylesheet" href="css/bootstrap-responsive.min.css" >
        <link rel="stylesheet" href="css/font-awesome.css" >
        <link rel="stylesheet" href="css/iot.css" >
        <style type="text/css">
            body {
                padding-top: 60px;
                padding-bottom: 40px;
                position: relative;
                z-index: 0;
            }
            #iot-canvas{
                width: 800px;
                height: 300px;
                border: 1px inset #333;
            }
            #pulse {
                width: 64px;
            }
        </style>

        <script type="text/javascript" src="lib/jquery-1.9.0.min.js"></script>
        <script type="text/javascript" src="lib/bootstrap/bootstrap.js"></script>
        <script type="text/javascript">
            var libScctPath="/app/lib/libscct";
            var libGeminiSocketPath="/app/lib/libscct/libgeminisocket";
        </script>
        <!--Load the GOOGLE AJAX API-->
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">
            var GOOGLECHARTS_ACTIVE=false;
            // Load the Visualization API and the piechart package.
            google.load('visualization', '1.0', {'packages':['corechart']});
            google.load('visualization', '1.0', {'packages':['gauge']});

            // Set a callback to run when the Google Visualization API is loaded.
            google.setOnLoadCallback(activateCharts);
            function activateCharts() {
                GOOGLECHARTS_ACTIVE=true;
            }
        </script>            
        <script type="text/javascript" src="lib/libscct/libscct.js"></script>        
        <script type="text/javascript" src="js/functions.js"></script> 
        <script type="text/javascript" src="js/signals.js"></script> 
        <script type="text/javascript" src="js/app.js"></script> 
        <!--Load the GOOGLE AJAX API-->
        <script type="text/javascript">            
            //Oggetto Logger
            function Logger(msg,obj){
                var logger=$("#iot-logger"),
                currDate=new Date();
                logger.prepend(currDate.toLocaleString()+" - "+msg+" "+obj.toString()+"\n<br>");
                console.log(obj);                                        
            };
            
            /*
             * set a cookie in the browser wiht the given name and value, that lasts for the given number of days
             */
            function setCookie(name,value,exdays)
            {
                var exdate=new Date();
                exdate.setDate(exdate.getDate() + exdays);
                var value=escape(value) + ((exdays==null) ? "" : "; expires="+exdate.toUTCString());
                document.cookie=name + "=" + value;
            }
            /*
             * try to retrive the value of the cookie with the given name
             */
            function getCookie(name)
            {
                var i,x,y,ARRcookies=document.cookie.split(";");
                for (i=0;i<ARRcookies.length;i++)
                {
                    x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));
                    y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);
                    x=x.replace(/^\s+|\s+$/g,"");
                    if (x==name)
                    {
                        return unescape(y);
                    }
                }
            }

			
            //On document load load the canvas..
            $(document).ready(function(){
                
                
                //ask for connection
                var scctChannel = new SCCTChannel();
                var iotDash=new IotDashboard(scctChannel);   //create the dashboard with the SCCTChannel
                
                // try to retrive connections parameters from cookies
                if (getCookie('host')){$("#server-host").val(getCookie('host'));}
                if (getCookie('port')){$("#server-port").val(getCookie('port'));}
                if (getCookie('apikey')){$("#server-apikey").val(getCookie('apikey'));}
                if (getCookie('tout')){$("#server-tout").val(getCookie('tout'));}
				
                $('#connectionModal').modal({keyboard: false,backdrop:"static"});
                $('#connectionModal #connect').click(function(e){
                    
                    var host=$("#server-host").val();
                    var port=$("#server-port").val();
                    var apikey=$("#server-apikey").val();
                    var tout=$("#server-tout").val();
					
                    //set connection parameters in cookies
                    setCookie('host',host,7);
                    setCookie('port',port,7);
                    setCookie('apikey',apikey,7);
                    setCookie('tout',tout,7);
                    /*
                    if(scctChannel!=null){
                        scctChannel.connectToPublisher(
                        't4sm.blogdns.com', //IP ADDRESS
                        '8089', //PORT
                        'SCS', //API KEY
                        3600 //TIMEOUT
                    );
                    }
                     */	
                    var connected=iotDash.connect(host,port,apikey,tout);
                    if(connected==true){
                        $('#connectionModal').modal('hide');                        
                        //iotDash.refreshGui();   //called too early....
                    }else{
                        alert('Impossibile connettersi');
                    }
                });                
                
                $('#startStream').click(function(e){
                    e.preventDefault();                    
                    iotDash.startStream();
                });
                $('#stopStream').click(function(e){
                    e.preventDefault();                    
                    iotDash.stopStream();
                });
				
                // controls -----
                $('#iot-controls-2-5-enable').click(function(e){
                    e.preventDefault();
                    console.log("Turn motor on");
                    iotDash.sendMessageData('switchMotorOn',100);
                });
                $('#iot-controls-2-5-disable').click(function(e){
                    e.preventDefault();
                    console.log("Turn motor off");
                    iotDash.sendMessageData('switchMotorOff',0);
                });
				
                $('#iot-controls-2-3-enable').click(function(e){
                    e.preventDefault();
                    console.log("Turn cooling on");
                    iotDash.sendMessageData('switchCoolingSystemOn',0);
                });
                $('#iot-controls-2-3-disable').click(function(e){
                    e.preventDefault();
                    console.log("Turn cooling off");
                    iotDash.sendMessageData('switchCoolingSystemOff',0);
                });
				
                $('#iot-controls-2-2-enable').click(function(e){
                    e.preventDefault();
                    console.log("Turn cutter on");
                    iotDash.sendMessageData('armcutter',0);
                });
                $('#iot-controls-2-2-disable').click(function(e){
                    e.preventDefault();
                    console.log("Turn cutter off");
                    iotDash.sendMessageData('disarmCutter',0);
                });
				
                $('#iot-controls-2-4-enable').click(function(e){
                    e.preventDefault();
                    console.log("Open injection");
                    iotDash.sendMessageData('openInjectionCircuit',0);
                });
                $('#iot-controls-2-4-disable').click(function(e){
                    e.preventDefault();
                    console.log("Close injection");
                    iotDash.sendMessageData('closeInjectioncircuit',0);
                });
                // end controls -
                
                $(window).bind("beforeunload", function() { 
                    return "Do you really want to close?";
                }
            )
                $(window).unload(function(){
                    alert("Goodbye!");
                    iotDash.disconnect();
                });
                
                $('.channel h2 > a').on('click',function(){
                    $(this).next('div').toggle();
                });
                
            });
        </script>
    </head>
    <body>   
        <div id="connectionModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h3 id="myModalLabel">Connect to server</h3>
            </div>
            <div class="modal-body">
                <form id="connectionForm" class="form-horizontal">
                    <fieldset>
                        <legend>Insert server parameters</legend>
                        <div class="control-group">
                            <label class="control-label">Server IP:</label>
                            <div class="controls">
                                <input id="server-host" type="text" placeholder="localhost">
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Server port:</label>
                            <div class="controls">
                                <input id="server-port" type="text" placeholder="3000">
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">API key:</label>
                            <div class="controls">
                                <input id="server-apikey" type="text" placeholder="scs">
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Timeout:</label>
                            <div class="controls">
                                <input id="server-tout" type="text" placeholder="20.00">
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button id="connect" class="btn btn-primary" data-loading-text="Connecting..." data-toggle="button">Connect</button>
            </div>
        </div>
        <header class="header">               
            <div class="navbar navbar-fixed-top navbar-inverse">
                <div class="navbar-inner">
                    <div class="container-narrow">
                        <a class="brand" href="/index.html" style="padding-top: 6px; padding-bottom: 0px;">
                            <img class="iot-small-logo" src="img/IOT-dashboard-02.jpg" />
                        </a>
                        <ul class="nav">
                            <li class="divider-vertical"></li>
                            <li class="active"><a href="/index.html#home">Home</a></li>
                            <li><a href="/index.html#about">About</a></li>
                            <li><a href="/index.html#contact">Contact</a></li>
                            <li class="divider-vertical"></li>
                        </ul>
                        <a class="btn btn-primary pull-right" href="https://github.com/GDGBrescia/iot-dashboard" target="_blank">
                            <i class="icon-github"></i>
                            Fork on GitHub</a>

                    </div>
                </div>
            </div>
        </header>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="hero-unit span12">
                    <div class="row-fluid">
                        <div class="span8">
                            <h2 id="system_name"></h2>
                            <p id="system_description"></p>
                            
                        </div>
                        <div class="span4">
                            <img id="pulse" src="/app/img/red-light.png">                            
                            <div class="btn-group">
                                <button id="startStream" class="btn btn-primary">Start Stream</button>
                                <button id="stopStream" class="btn btn-warning">Stop Stream</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tabbable tabs-left"> <!-- Only required for left/right tabs -->
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#tab-alarms" data-toggle="tab">System Alarms</a></li>
                    <li><a href="#tab-pressures" data-toggle="tab">Blades Pressures</a></li>
                    <li><a href="#tab-Hw" data-toggle="tab">Hardware</a></li>
                    <li><a href="#tab-raw" data-toggle="tab">Raw data</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="tab-alarms">
                        <h3>System alarms</h3>
                        <ul>                           
                            <li>
                                <div id="1_0"></div>                                
                            </li>
                            <li>
                                <div id="1_1"></div>                                
                            </li>
                            <li>
                                <div id="1_2"></div>                                
                            </li>
                            <li>
                                <div id="1_3"></div>                                
                            </li>
                            <li>
                                <div id="1_4"></div>                                
                            </li>
                            <li>
                                <div id="1_5"></div>                                
                            </li>
                            <li>
                                <div id="1_6"></div>                                
                            </li>
                            <li>
                                <div id="1_7"></div>                                
                            </li>
                        </ul>
                        <h3>Connection parameters</h3>
                        <div id="system_conn_parameters"></div>
                    </div>
                    <div class="tab-pane " id="tab-pressures">
                        <h3>Blades pressures</h3>
                        <div id="all-pressure-chart"></div>
                        <ul>
                            <li>
                                <div id="101_0_ch"></div>
                            </li>
                            <li>
                                <div id="101_1_ch"></div>
                            </li>
                            <li>
                                <div id="101_2_ch"></div>
                            </li>
                            <li>
                                <div id="101_3_ch"></div>
                            </li>
                            <li>
                                <div id="101_4_ch"></div>
                            </li>
                             <li>
                                <div id="101_5_ch"></div>
                            </li>
                            <li>
                                <div id="101_6_ch"></div>
                            </li>
                            <li>
                                <div id="101_7_ch"></div>
                            </li>
                        </ul>
                        <h3>Connection parameters</h3>
                        <div id="system_conn_parameters"></div>
                    </div>
                    <div class="tab-pane " id="tab-Hw">
                        <h3>System modules</h3>
                        <ul>
                            <li>
                                <div id="system_hw"></div>                                
                            </li>
                            <li>
                                <div id="1_0"></div>                                
                            </li>
                            <li>
                                <div id="1_1"></div>                                
                            </li>
                            <li>
                                <div id="1_2"></div>                                
                            </li>
                            <li>
                                <div id="1_3"></div>                                
                            </li>
                        </ul>
                        <h3>Connection parameters</h3>
                        <div id="system_conn_parameters"></div>
                    </div>
                    <div class="tab-pane" id="tab-raw">
                        <div id="rowdata" class="row-fluid channel">
                            <div class="span12 well">
                                <h3>Row Data</h3>
                                <h4>This is the row data passed from the SCS system.</h4>
                                <p>Number of total products: <span id="system_availableProductTypes">0</span></p>
                                <p>Max motor speed: <span id="system_maxMotorSpeed">0</span> RPM</p>
                                <div id="iot-rowdata"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="footer">
                <p class="muted credit">Powered by GDG Brescia & T4SM</p>
                <p class="muted credit">Code licensed under the
                    <a href="http://www.gnu.org/licenses/gpl-2.0.html" target="_blank">
                        GNU General Public License, version 2</a>.
                    Documentation licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.
                </p>
            </footer>
        </div>
    </body>
</html>