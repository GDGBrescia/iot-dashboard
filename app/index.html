<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="utf-8">
        <meta name="Description" content="">
        <title>IoT Dashboard - Powered by GDG Brescia & T4SM</title>
        <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
        <link rel="stylesheet" href="css/bootstrap-responsive.min.css" type="text/css">
        <link rel="stylesheet" href="css/font-awesome.css" type="text/css">
        <link rel="stylesheet" href="css/istogram.css" type="text/css">
        <link rel="stylesheet" href="css/iot.css" type="text/css">
        <style type="text/css">
            body {
                padding-top: 60px;
                padding-bottom: 40px;
                position: relative;
                z-index: 0;
            }           
        </style>

        <script type="text/javascript" src="lib/jquery-1.9.0.min.js"></script>
        <script type="text/javascript" src="lib/bootstrap/bootstrap.js"></script>
        <script type="text/javascript">
            var libScctPath="/app/lib/libscct";
            var libGeminiSocketPath="/app/lib/libscct/libgeminisocket";
        </script>
        <script src="lib/highcharts/highcharts.js"></script>
        <script src="lib/highcharts/highcharts-more.js"></script>
        <script src="lib/highcharts/modules/exporting.js"></script>
        <!-- IOT LIBS -->
        <script type="text/javascript" src="lib/Istogram3DBar.js"></script> 
        <script type="text/javascript" src="lib/libscct/libscct.js"></script>        
        <script type="text/javascript" src="js/functions.js"></script> 
        <script type="text/javascript" src="js/signals.js"></script> 
        <script type="text/javascript" src="js/app.js"></script> 
        <script type="text/javascript">            
            //Oggetto Logger
            function Logger(msg,obj){
                var logger=$("#iot-logger"),
                currDate=new Date();
                logger.prepend(currDate.toLocaleString()+" - "+msg+" "+obj.toString()+"\n<br>");
                console.log(obj);                                        
            };
            
            /*
             * set a cookie in the browser wiht the given name and value, that lasts for the given number of days
             */
            function setCookie(name,value,exdays)
            {
                var exdate=new Date();
                exdate.setDate(exdate.getDate() + exdays);
                var value=escape(value) + ((exdays==null) ? "" : "; expires="+exdate.toUTCString());
                document.cookie=name + "=" + value;
            }
            /*
             * try to retrive the value of the cookie with the given name
             */
            function getCookie(name)
            {
                var i,x,y,ARRcookies=document.cookie.split(";");
                for (i=0;i<ARRcookies.length;i++)
                {
                    x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));
                    y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);
                    x=x.replace(/^\s+|\s+$/g,"");
                    if (x==name)
                    {
                        return unescape(y);
                    }
                }
            }

			//made the dashboard a global variable...
			var iotDash = {};

			
            //On document load load the canvas..
            $(document).ready(function(){
                
                Highcharts.setOptions({
                    global: {
                        useUTC: false
                    }
                });
                
                
                //ask for connection
                var scctChannel = new SCCTChannel();
                iotDash=new IotDashboard(scctChannel);   //create the dashboard with the SCCTChannel
                
                // try to retrive connections parameters from cookies
                if (getCookie('host')){$("#server-host").val(getCookie('host'));}
                if (getCookie('port')){$("#server-port").val(getCookie('port'));}
                if (getCookie('apikey')){$("#server-apikey").val(getCookie('apikey'));}
                if (getCookie('tout')){$("#server-tout").val(getCookie('tout'));}
				
                $('#connectionModal').modal({keyboard: false,backdrop:"static"});
                $('#connectionModal #connect').click(function(e){
                    
                    var host=$("#server-host").val();
                    var port=$("#server-port").val();
                    var apikey=$("#server-apikey").val();
                    var tout=$("#server-tout").val();
					
                    //set connection parameters in cookies
                    setCookie('host',host,7);
                    setCookie('port',port,7);
                    setCookie('apikey',apikey,7);
                    setCookie('tout',tout,7);
                    /*
                    if(scctChannel!=null){
                        scctChannel.connectToPublisher(
                        't4sm.blogdns.com', //IP ADDRESS
                        '8089', //PORT
                        'SCS', //API KEY
                        3600 //TIMEOUT
                    );
                    }
                     */	
                    var connected=iotDash.connect(host,port,apikey,tout);
					$('#connectionModal').modal('hide');
					
					/* //this condition was useless, check contidions inside IotDashboard.connect(...)
                    if(connected==true){
                        $('#connectionModal').modal('hide');                        
                        //iotDash.refreshGui();   //called too early....                        
                    }else{
                        alert('Impossibile connettersi');
                    }
					*/
                });                
                
				/* buttons removed. 
                $('#startStream').click(function(e){
                    e.preventDefault();                    
                    iotDash.startStream();
                });
                $('#stopStream').click(function(e){
                    e.preventDefault();                    
                    iotDash.stopStream();
                });
				*/
				
                // controls -----
				
				//note that the disable/enable button for the motors are flipped
				//because the signal is "motor is off". when you try to disable the
				//"motor off signal" you are actually turning it on.
                $('#iot-controls-2-5-disable').click(function(e){
                    e.preventDefault();
                    console.log("Turn motor on");
                    iotDash.sendMessageData('switchMotorOn',100);
                });
                $('#iot-controls-2-5-enable').click(function(e){
                    e.preventDefault();
                    console.log("Turn motor off");
                    iotDash.sendMessageData('switchMotorOff',0);
                });
				
                $('#iot-controls-2-3-enable').click(function(e){
                    e.preventDefault();
                    console.log("Turn cooling on");
                    iotDash.sendMessageData('switchCoolingSystemOn',0);
                });
                $('#iot-controls-2-3-disable').click(function(e){
                    e.preventDefault();
                    console.log("Turn cooling off");
                    iotDash.sendMessageData('switchCoolingSystemOff',0);
                });
				
                $('#iot-controls-2-2-enable').click(function(e){
                    e.preventDefault();
                    console.log("Turn cutter on");
                    iotDash.sendMessageData('armCutter',0);
                });
                $('#iot-controls-2-2-disable').click(function(e){
                    e.preventDefault();
                    console.log("Turn cutter off");
                    iotDash.sendMessageData('disarmCutter',0);
                });
				
                $('#iot-controls-2-4-enable').click(function(e){
                    e.preventDefault();
                    console.log("Open injection");
                    iotDash.sendMessageData('openInjectionCircuit',0);
                });
                $('#iot-controls-2-4-disable').click(function(e){
                    e.preventDefault();
                    console.log("Close injection");
                    iotDash.sendMessageData('closeInjectionCircuit',0);
                });
                // end controls -
                
                $(window).bind("beforeunload", function() { 
                    return "Do you really want to close?";
                }
            )
                $(window).unload(function(){
                    alert("Goodbye!");
                    iotDash.disconnect();
                });
            });
        </script>
    </head>
    <body>   
        <div id="connectionModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h3 id="myModalLabel">Connect to server</h3>
            </div>
            <div class="modal-body">
                <form id="connectionForm" class="form-horizontal">
                    <fieldset>
                        <legend>Insert server parameters</legend>
                        <div class="control-group">
                            <label class="control-label">Server IP:</label>
                            <div class="controls">
                                <input id="server-host" type="text" placeholder="localhost" required>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Server port:</label>
                            <div class="controls">
                                <input id="server-port" type="text" placeholder="8089" required>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">API key:</label>
                            <div class="controls">
                                <input id="server-apikey" type="text" placeholder="scs" required>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Timeout:</label>
                            <div class="controls">
                                <input id="server-tout" type="text" placeholder="30" required>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button id="connect" class="btn btn-primary" data-loading-text="Connecting..." data-toggle="button">Connect</button>
            </div>
        </div>
        <header class="header">               
            <div class="navbar navbar-fixed-top navbar-inverse">
                <div class="navbar-inner">
                    <div class="container-narrow">
                        <a class="brand" href="/index.html" style="padding-top: 6px; padding-bottom: 0px;">
                            <img class="iot-small-logo" src="img/IOT-dashboard-02.jpg" />
                        </a>
                        <ul class="nav">
                            <li class="divider-vertical"></li>
                            <li class="active"><a href="/index.html#home">Home</a></li>
                            <li><a href="/index.html#about">About</a></li>
                            <li><a href="/index.html#contact">Contact</a></li>
                            <li class="divider-vertical"></li>
                        </ul>
                        <a class="btn btn-primary pull-right" href="https://github.com/GDGBrescia/iot-dashboard" target="_blank">
                            <i class="icon-github"></i>
                            Fork on GitHub</a>

                    </div>
                </div>
            </div>
        </header>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="hero-unit span9">
                    <h2 id="system_name"></h2>
                    <p id="system_description"></p>
                    <div id="iot-status">
                        <h3>System status</h3>
                        <ul>                           
                            <li>
                                <div id="2_0"></div>                                
                            </li>
                            <li>
                                <div id="2_1"></div>                                
                            </li>
                            <li>
                                <div id="2_2"></div>                                
                            </li>
                            <li>
                                <div id="2_3"></div>                                
                            </li>
                            <li>
                                <div id="2_4"></div>                                
                            </li>
                            <li>
                                <div id="2_5"></div>                                
                            </li>
                            <li>
                                <div id="2_6"></div>                                
                            </li>
                            <li>
                                <div id="2_7"></div>                                
                            </li>
                        </ul> 
                    </div>
                    <div id="iot-alarms">
                        <h3>System alarms</h3>
                        <ul>                           
                            <li>
                                <div id="1_0"></div>                                
                            </li>
                            <li>
                                <div id="1_1"></div>                                
                            </li>
                            <li>
                                <div id="1_2"></div>                                
                            </li>
                            <li>
                                <div id="1_3"></div>                                
                            </li>
                            <li>
                                <div id="1_4"></div>                                
                            </li>
                            <li>
                                <div id="1_5"></div>                                
                            </li>
                            <li>
                                <div id="1_6"></div>                                
                            </li>
                            <li>
                                <div id="1_7"></div>                                
                            </li>
                        </ul>     
                    </div>
                </div>
                <div id="console" data-spy="affix" data-offset-top="40" class="span3 pull-right" style="right:16px">
					<div>
						<img id="pulse" src="/app/img/red-light.png">
						<span id="connectionlog"> </span>
						<br/>
						<span id="streamlog"> </span>
					</div>
                    <hr>
                    <div id="speedChart">
                        <div id="100_1"></div>
                        <div id="100_0"></div>
                        <p class="mratio"><b>Motor ratio:</b></p>
                        <div class="speed-signal progress progress-striped">
                            <div id="100_1_ch" class="bar bar-success"></div>
                            <div id="100_0_ch" class="bar bar-danger"></div>
                        </div>
                    </div>
                    <hr>
                    <div id="iot-controls">                                
                        <h3>Control panel</h3>
                        <div class="btn-group btn-group-vertical">
							<!-- note that the activate/deactivate motors are actually flipped, as above. -->
                            <button id="iot-controls-2-5-enable" class="btn  btn-block btn-warning" style="display:none;">Deactivate motor</button>
                            <button id="iot-controls-2-5-disable" class="btn  btn-block btn-info">Activate motor</button>
                            <button id="iot-controls-2-3-enable" class="btn  btn-block btn-info">Enable cooling system</button>
                            <button id="iot-controls-2-3-disable" class="btn  btn-block btn-warning" style="display:none;">Disable cooling system</button>
                            <button id="iot-controls-2-2-enable" class="btn  btn-block btn-info">Arm cutter</button>
                            <button id="iot-controls-2-2-disable" class="btn  btn-block btn-warning" style="display:none;">Disarm cutter</button>
                            <button id="iot-controls-2-4-enable" class="btn  btn-block btn-info">Open injection circuit</button>
                            <button id="iot-controls-2-4-disable" class="btn  btn-block btn-warning" style="display:none;">Close injection circuit</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span9">
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#tab-pressures" data-toggle="tab">Blades Pressures</a></li>
                        <li><a href="#tab-slow" data-toggle="tab">Slow signals</a></li>
                        <li><a href="#tab-products" data-toggle="tab">Producted Products</a></li>
                        <li><a href="#tab-Hw" data-toggle="tab">Hardware</a></li>
                        <li><a href="#tab-raw" data-toggle="tab">Raw data</a></li>
                    </ul>
                    <div class="tab-content">                    
                        <div class="tab-pane " id="tab-products">
                            <h3>Producted Products</h3>
                            <h4>Displays number of producted products.</h4>
                            <ul>
                                <li>                                
                                    <div id="201_0"></div>
                                    <div id="3_0"></div
                                </li>
                                <li>
                                    <div id="201_1"></div>
                                    <div id="3_1"></div
                                </li>
                                <li>
                                    <div id="201_2"></div>
                                    <div id="3_2"></div
                                </li>
                                <li>
                                    <div id="201_3"></div>
                                    <div id="3_3"></div
                                </li>
                                <li>
                                    <div id="201_4"></div>
                                    <div id="3_4"></div
                                </li>
                                <li>
                                    <div id="201_5"></div>
                                    <div id="3_5"></div
                                </li>
                                <li>
                                    <div id="201_6"></div>
                                    <div id="3_6"></div
                                </li>
                                <li>
                                    <div id="201_7"></div>
                                    <div id="3_7"></div
                                </li>
                            </ul>   
                        </div>
                        <div class="tab-pane active" id="tab-pressures">
                            <h3>Blades pressures</h3>
                            <ul>
                                <li>                                
                                    <div id="101_0_ch" class="iot3dchart"></div>
                                    <div id="101_0"></div>
                                </li>
                                <li>
                                    <div id="101_1_ch" class="iot3dchart"></div>
                                    <div id="101_1"></div>
                                </li>
                                <li>
                                    <div id="101_2_ch" class="iot3dchart"></div>
                                    <div id="101_2"></div>
                                </li>
                                <li>
                                    <div id="101_3_ch" class="iot3dchart"></div>
                                    <div id="101_3"></div>
                                </li>
                                <li>
                                    <div id="101_4_ch" class="iot3dchart"></div>
                                    <div id="101_4"></div>
                                </li>
                                <li>
                                    <div id="101_5_ch" class="iot3dchart"></div>
                                    <div id="101_5"></div>
                                </li>
                                <li>
                                    <div id="101_6_ch" class="iot3dchart"></div>
                                    <div id="101_6"></div>
                                </li>
                                <li>
                                    <div id="101_7_ch" class="iot3dchart"></div>
                                    <div id="101_7"></div>
                                </li>
                            </ul>                       
                        </div>
                        <div class="tab-pane " id="tab-slow">
                            <h3>Slow signals</h3>
                            <ul>                            
                                <li>
                                    <div id="200_0_ch" class="iot3dchart"></div>                                
                                    <div id="200_0"></div>                                
                                </li>
                                <li>
                                    <div id="200_1_ch" class="iot3dchart"></div>                                
                                    <div id="200_1"></div>                                
                                </li>
                                <li>
                                    <div id="200_2_ch" class="iot3dchart"></div>                                
                                    <div id="200_2"></div>                                
                                </li>
                                <li>
                                    <div id="200_3_ch" class="iot3dchart"></div>                                
                                    <div id="200_3"></div>                                
                                </li>
                            </ul>
                        </div>
                        <div class="tab-pane " id="tab-Hw">
                            <h3>System modules</h3>
                            <ul>
                                <li>
                                    <div id="system_hw"></div>                                
                                </li>
                                <li>
                                    <div id="1_0"></div>                                
                                </li>
                                <li>
                                    <div id="1_1"></div>                                
                                </li>
                                <li>
                                    <div id="1_2"></div>                                
                                </li>
                                <li>
                                    <div id="1_3"></div>                                
                                </li>
                            </ul>
                            <h3>Connection parameters</h3>
                            <div id="system_conn_parameters"></div>
                        </div>
                        <div class="tab-pane" id="tab-raw">
                            <div id="rowdata" class="row-fluid channel">
                                <div class="span12 well">
                                    <h3>Row Data</h3>
                                    <h4>This is the row data passed from the SCS system.</h4>
                                    <p>Number of total products: <span id="system_availableProductTypes">0</span></p>
                                    <p>Max motor speed: <span id="system_maxMotorSpeed">0</span> RPM</p>
                                    <div id="iot-rowdata"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="footer">
                <p class="muted credit">Powered by GDG Brescia & T4SM</p>
                <p class="muted credit">Code licensed under the
                    <a href="http://www.gnu.org/licenses/gpl-2.0.html" target="_blank">
                        GNU General Public License, version 2</a>.
                    Documentation licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.
                </p>
            </footer>
        </div>
    </body>
</html>